<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Topic 5 Estimating causal effects | STAT 394: Causal Inference</title>
  <meta name="description" content="This is the class website for Causal Inference at Macalester College." />
  <meta name="generator" content="bookdown 0.14 and GitBook 2.6.7" />

  <meta property="og:title" content="Topic 5 Estimating causal effects | STAT 394: Causal Inference" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the class website for Causal Inference at Macalester College." />
  <meta name="github-repo" content="lmyint/causal_spring_2020" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Topic 5 Estimating causal effects | STAT 394: Causal Inference" />
  
  <meta name="twitter:description" content="This is the class website for Causal Inference at Macalester College." />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="d-separation-part-2.html"/>
<link rel="next" href="ip-weighting-in-practice.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #2a211c; color: #bdae9d; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; background-color: #2a211c; color: #bdae9d; border-right: 1px solid #bdae9d; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #bdae9d; background-color: #2a211c; }
code > span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code > span.dt { text-decoration: underline; } /* DataType */
code > span.dv { color: #44aa43; } /* DecVal */
code > span.bn { color: #44aa43; } /* BaseN */
code > span.fl { color: #44aa43; } /* Float */
code > span.ch { color: #049b0a; } /* Char */
code > span.st { color: #049b0a; } /* String */
code > span.co { color: #0066ff; font-style: italic; } /* Comment */
code > span.al { color: #ffff00; } /* Alert */
code > span.fu { color: #ff9358; font-weight: bold; } /* Function */
code > span.er { color: #ffff00; font-weight: bold; } /* Error */
code > span.wa { color: #ffff00; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #049b0a; } /* SpecialChar */
code > span.vs { color: #049b0a; } /* VerbatimString */
code > span.ss { color: #049b0a; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { font-weight: bold; } /* Preprocessor */
code > span.at { } /* Attribute */
code > span.do { color: #0066ff; font-style: italic; } /* Documentation */
code > span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code > span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code > span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="custom_styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href = "./">STAT 394: Causal Inference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome!</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html"><i class="fa fa-check"></i>Schedule</a><ul>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html#week-1"><i class="fa fa-check"></i>Week 1</a></li>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html#week-2"><i class="fa fa-check"></i>Week 2</a></li>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html#week-3"><i class="fa fa-check"></i>Week 3</a></li>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html#week-4"><i class="fa fa-check"></i>Week 4</a></li>
<li class="chapter" data-level="" data-path="schedule.html"><a href="schedule.html#week-5"><i class="fa fa-check"></i>Week 5</a></li>
</ul></li>
<li class="part"><span><b>I Causal Diagram Fundamentals</b></span></li>
<li class="chapter" data-level="1" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html"><i class="fa fa-check"></i><b>1</b> Introductions, Review, and Motivation</a><ul>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#learning-goals"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#review-regression-models"><i class="fa fa-check"></i>Review: Regression Models</a></li>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#exercises"><i class="fa fa-check"></i>Exercises</a><ul>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#exercise-1"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#exercise-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="introductions-review-and-motivation.html"><a href="introductions-review-and-motivation.html#exercise-3"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="probability-and-dags.html"><a href="probability-and-dags.html"><i class="fa fa-check"></i><b>2</b> Probability and DAGs</a><ul>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#learning-goals-1"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#goal-1"><i class="fa fa-check"></i>Goal 1</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#lead-in-to-r-activity-poll"><i class="fa fa-check"></i>Lead-in to R activity: Poll</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#discussion"><i class="fa fa-check"></i>Discussion</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#r-exercises"><i class="fa fa-check"></i>R Exercises</a><ul>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#exercise-1-1"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#exercise-2-1"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#exercise-3-1"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#conceptual-exercises"><i class="fa fa-check"></i>Conceptual Exercises</a><ul>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#exercise-4"><i class="fa fa-check"></i>Exercise 4</a></li>
<li class="chapter" data-level="" data-path="probability-and-dags.html"><a href="probability-and-dags.html#exercise-5"><i class="fa fa-check"></i>Exercise 5</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="d-separation-part-1.html"><a href="d-separation-part-1.html"><i class="fa fa-check"></i><b>3</b> d-separation (Part 1)</a><ul>
<li class="chapter" data-level="" data-path="d-separation-part-1.html"><a href="d-separation-part-1.html#learning-goals-2"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-1.html"><a href="d-separation-part-1.html#discussion-d-separation"><i class="fa fa-check"></i>Discussion: d-separation</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-1.html"><a href="d-separation-part-1.html#discussion-the-birth-weight-paradox"><i class="fa fa-check"></i>Discussion: The Birth Weight Paradox</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html"><i class="fa fa-check"></i><b>4</b> d-separation (Part 2)</a><ul>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#learning-goals-3"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#why-care"><i class="fa fa-check"></i>Why care?</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#example-folic-acid-and-birth-defects"><i class="fa fa-check"></i>Example: Folic Acid and Birth Defects</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#example-selection-bias"><i class="fa fa-check"></i>Example: Selection Bias</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#example-estrogens-and-uterine-cancer"><i class="fa fa-check"></i>Example: Estrogens and Uterine Cancer</a></li>
<li class="chapter" data-level="" data-path="d-separation-part-2.html"><a href="d-separation-part-2.html#principles-of-building-causal-diagrams"><i class="fa fa-check"></i>Principles of building causal diagrams</a></li>
</ul></li>
<li class="part"><span><b>II Causal Effect Estimation</b></span></li>
<li class="chapter" data-level="5" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html"><i class="fa fa-check"></i><b>5</b> Estimating causal effects</a><ul>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#learning-goals-4"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#exercise-dag-construction"><i class="fa fa-check"></i>Exercise: DAG construction</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#warm-up-d-separation"><i class="fa fa-check"></i>Warm-up: d-separation</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#discussion-estimating-causal-effects"><i class="fa fa-check"></i>Discussion: Estimating causal effects</a><ul>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#worksheet-developing-ideas"><i class="fa fa-check"></i>Worksheet: developing ideas</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#notes-deriving-inverse-probability-weighting"><i class="fa fa-check"></i>Notes: deriving inverse probability weighting</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#exercise-simulation-planning"><i class="fa fa-check"></i>Exercise: Simulation planning</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#simulation-example"><i class="fa fa-check"></i>Simulation example</a></li>
<li class="chapter" data-level="" data-path="estimating-causal-effects.html"><a href="estimating-causal-effects.html#on-your-own"><i class="fa fa-check"></i>On your own</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ip-weighting-in-practice.html"><a href="ip-weighting-in-practice.html"><i class="fa fa-check"></i><b>6</b> IP weighting in practice</a><ul>
<li class="chapter" data-level="" data-path="ip-weighting-in-practice.html"><a href="ip-weighting-in-practice.html#learning-goals-5"><i class="fa fa-check"></i>Learning Goals</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-in-practice.html"><a href="ip-weighting-in-practice.html#analysis"><i class="fa fa-check"></i>Analysis</a></li>
</ul></li>
<li class="part"><span><b>III Homework</b></span></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html"><i class="fa fa-check"></i>Homework 1</a><ul>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#conceptual-exercises-1"><i class="fa fa-check"></i>Conceptual Exercises</a><ul>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-1-2"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-2-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-3-2"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#simulation-exercises"><i class="fa fa-check"></i>Simulation Exercises</a><ul>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-4-1"><i class="fa fa-check"></i>Exercise 4</a></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-5-1"><i class="fa fa-check"></i>Exercise 5</a></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-6"><i class="fa fa-check"></i>Exercise 6</a></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#exercise-7"><i class="fa fa-check"></i>Exercise 7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="homework-1.html"><a href="homework-1.html#portfolio"><i class="fa fa-check"></i>Portfolio</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="homework-2.html"><a href="homework-2.html"><i class="fa fa-check"></i>Homework 2</a><ul>
<li class="chapter" data-level="" data-path="homework-2.html"><a href="homework-2.html#in-class-activities-estimating-causal-effects"><i class="fa fa-check"></i>In-class activities: Estimating causal effects</a></li>
<li class="chapter" data-level="" data-path="homework-2.html"><a href="homework-2.html#in-class-activities-ip-weighting-in-practice"><i class="fa fa-check"></i>In-class activities: IP weighting in practice</a></li>
</ul></li>
<li class="part"><span><b>IV Projects</b></span></li>
<li class="chapter" data-level="" data-path="portfolio-1.html"><a href="portfolio-1.html"><i class="fa fa-check"></i>Portfolio</a><ul>
<li class="chapter" data-level="" data-path="portfolio-1.html"><a href="portfolio-1.html#required-topics"><i class="fa fa-check"></i>Required Topics</a></li>
<li class="chapter" data-level="" data-path="portfolio-1.html"><a href="portfolio-1.html#iterative-progress"><i class="fa fa-check"></i>Iterative Progress</a></li>
<li class="chapter" data-level="" data-path="portfolio-1.html"><a href="portfolio-1.html#building-a-personal-website"><i class="fa fa-check"></i>Building a Personal Website</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">STAT 394: Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimating-causal-effects" class="section level1">
<h1><span class="header-section-number">Topic 5</span> Estimating causal effects</h1>
<div id="learning-goals-4" class="section level2 unnumbered">
<h2>Learning Goals</h2>
<ol style="list-style-type: decimal">
<li>Practice constructing a causal diagram from the ground up in consultation with fellow experts</li>
<li>Extend d-separation ideas to the estimation of causal effects</li>
<li>Develop the idea of inverse probability of treatment weighting (IPW or IPTW) for causal effect estimation</li>
<li>Understand how the do-operator is related to inverse probability weighting</li>
</ol>
<p><br><br><br><br></p>
</div>
<div id="exercise-dag-construction" class="section level2 unnumbered">
<h2>Exercise: DAG construction</h2>
<p><strong>Research question:</strong> What is the causal effect of participating in yoga once per week for 12 weeks on resting heart rate at the end of that period?</p>
<ul>
<li>We are trying to design an observational study that could be carried out at Macalester.</li>
</ul>
<p>Recall our principles for constructing causal DAGs:</p>
<ul>
<li>A DAG is a <strong>causal DAG</strong> if it is <strong>common cause-complete</strong>: for any two variables in the DAG, common causes (whether measured or unmeasured) of those variables are shown.</li>
<li>A causal DAG does <strong>NOT</strong> need to be <strong>cause-complete</strong> (infeasible due to infinite regress of causes).</li>
<li>It <strong>should</strong> contain variables that are selected on, and subsequently common causes between those variables and existing variables.</li>
</ul>
<p><br><br></p>
<p><strong>Reflect:</strong> Write about the process of constructing the causal diagram with your colleagues.</p>
<ul>
<li>How did your discussions flow?</li>
<li>How did you resolve (or not) any disagreements on the structure?</li>
<li>Were you able to decide if your diagram was good enough? If so, how?</li>
<li>What questions or concerns do you still have about this process?</li>
</ul>
<p><br></p>
<p><strong>Further reading:</strong></p>
<ul>
<li>Chapter 9 of our WHATIF book (see <a href="references.html#references">References</a>) introduces the consideration of measurement error. We won’t talk about measurement error in this course but you are welcome to read about these ideas on your own.</li>
<li>Chapters 6, 7, and 8 talk about causal diagrams, confounding, and selection bias. This another resource to complement PRIMER.</li>
</ul>
<p><br><br><br><br></p>
</div>
<div id="warm-up-d-separation" class="section level2 unnumbered">
<h2>Warm-up: d-separation</h2>
<p>Navigate to:</p>
<center>
<a href="https://www.PollEv.com/lesliemyint417">PollEv.com/lesliemyint417</a>
</center>
<p><br></p>
<p>Slides of the causal diagrams (with solutions) are available <a href="https://docs.google.com/presentation/d/1tqrHo-zAPNkQ3dVfd8AVz3xCOVGwMiubDOAtQzO4GPg/edit?usp=sharing">here</a>.</p>
<p><br><br><br><br></p>
</div>
<div id="discussion-estimating-causal-effects" class="section level2 unnumbered">
<h2>Discussion: Estimating causal effects</h2>
<p>In adjusting for variables in our analysis, we want to “do no harm”:</p>
<ul>
<li>Block non-causal paths that generate unwanted associations</li>
<li>Do not accidentally create non-causal paths that generate unwanted associations</li>
<li>Leave causal paths (chains) alone</li>
</ul>
<p><br></p>
<p>This was actually the rationale behind the <strong>backdoor criterion</strong>. (We’ll get back to this soon.)</p>
<p><strong>The do-operator</strong></p>
<ul>
<li>One notion of causation is that of <strong>intervention</strong>: setting a variable’s value</li>
<li>There is a difference between <span class="math inline">\(P(Y \mid A = a)\)</span> and <span class="math inline">\(P(Y \mid \hbox{do}(A = a))\)</span>.
<ul>
<li><span class="math inline">\(P(Y \mid A = a)\)</span> is an observational probability</li>
<li><span class="math inline">\(P(Y \mid \hbox{do}(A = a))\)</span> is an intervention probability</li>
</ul></li>
<li>When we intervene on <span class="math inline">\(A\)</span>, this amounts to removing all arrows <em>into</em> <span class="math inline">\(A\)</span>.</li>
</ul>
<center>
<img src="images/d_sep_practice_05.png" />
</center>
<ul>
<li>The do-operator allows us to graphically simulate interventions.</li>
<li>In the world that was intervened on (manipulated), what do relationships between variables look like?</li>
<li>Rules of probability combined with a set of graph rules (called the <strong>do-calculus</strong>) allow us to relate the relationships in the manipulated graph to relationships that we observe in the real world.</li>
</ul>
<p><span class="math display">\[ \hbox{Average causal effect} = P(Y = y \mid \hbox{do}(A = 1)) - P(Y = y \mid \hbox{do}(A = 0)) \]</span></p>
<ul>
<li><span class="math inline">\(Y\)</span> is the outcome and <span class="math inline">\(A\)</span> is the treatment (action) variable</li>
</ul>
<p><br><br></p>
<p>Taste of do-calculus next week. For now, let’s approach effect estimation from a different angle:</p>
<ul>
<li>The mathematical expressions in PRIMER for <span class="math inline">\(P(y \mid \hbox{do}(a))\)</span> had something in common –&gt; let’s develop this idea and relate to something familiar: d-separation</li>
</ul>
<p><br><br><br><br></p>
<div id="worksheet-developing-ideas" class="section level3 unnumbered">
<h3>Worksheet: developing ideas</h3>
<p>Worksheet (with solutions) available <a href="https://docs.google.com/presentation/d/1BEK75PKWGWSmL9FxDmKLevJwPOXFsl70LtHJAnXZAko/edit?usp=sharing">here</a></p>
<p><br><br><br><br></p>
</div>
<div id="notes-deriving-inverse-probability-weighting" class="section level3 unnumbered">
<h3>Notes: deriving inverse probability weighting</h3>
<ul>
<li>If treatment <span class="math inline">\(A\)</span> and outcome <span class="math inline">\(Y\)</span> are d-separated given <span class="math inline">\(Z\)</span> under the null (under the null hypothesis of no causal effect), then there are no open “spurious” paths generating unwanted associations between <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>.
<ul>
<li>No open <strong>backdoor paths</strong> (paths with arrows into <span class="math inline">\(A\)</span>): these generate confounding.</li>
<li>No paths with collision nodes or descendants of collision nodes that are conditioned on: this opens paths that would otherwise be naturally blocked by the collision nodes.</li>
</ul></li>
</ul>
<p><br><br></p>
<ul>
<li>Then the outcomes of the treated and untreated are “comparable”.
<ul>
<li>No open spurious paths.</li>
</ul></li>
</ul>
<p><br><br><br><br></p>
<ul>
<li>If the outcomes of the treated and untreated are “comparable”, then…
<ul>
<li>We can upweight those <em>treated</em> to “create” a population where everyone was <em>treated</em> –&gt; look at outcome distributions in this population (e.g., <span class="math inline">\(P(Y = 1)\)</span>).
<ul>
<li>These weights are the inverse of <span class="math inline">\(P(A = 1\mid Z)\)</span>.</li>
</ul></li>
<li>We can upweight those <em>not treated</em> to “create” a population where everyone was <em>not treated</em> –&gt; look at outcome distributions in this population (e.g., <span class="math inline">\(P(Y = 1)\)</span>).
<ul>
<li>These weights are the inverse of <span class="math inline">\(P(A = 0\mid Z)\)</span>.</li>
</ul></li>
</ul></li>
</ul>
<p><br><br><br><br></p>
<ul>
<li>These outcome distributions are actually interpreted as:
<ul>
<li>All treated: <span class="math inline">\(P(Y = 1 \mid \hbox{do}(A = 1))\)</span></li>
<li>All not treated: <span class="math inline">\(P(Y = 1 \mid \hbox{do}(A = 0))\)</span></li>
<li>Note: we have appealed to what it conceptually means to do/intervene. We haven’t done any “graph surgery”.</li>
</ul></li>
</ul>
<p><span class="math display">\[ \hbox{Average causal effect} = \hbox{ACE} = P(Y = 1 \mid \hbox{do}(A = 1)) - P(Y = 1 \mid \hbox{do}(A = 0)) \]</span></p>
<ul>
<li>If ACE = 0.1, interpreted as:
<ul>
<li>The probability of recovery (<span class="math inline">\(Y = 1\)</span>) is 10% higher if we treat everyone, as compared to if we treat no one.</li>
</ul></li>
</ul>
<p><br><br><br><br></p>
<ul>
<li>The individual “do” probabilities are actually weighted averages of the outcome variable: <span class="math display">\[ P(Y = 1 \mid \hbox{do}(A = a)) = \frac{\sum_i w_i y_i}{\sum_i w_i} \]</span>
<ul>
<li><span class="math inline">\(w_i\)</span> is the appropriate weight for case <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(y_i\)</span> is the outcome for case <span class="math inline">\(i\)</span></li>
<li>The sum is over all treated for <span class="math inline">\(a = 1\)</span> and over all untreated for <span class="math inline">\(a = 0\)</span>.</li>
</ul></li>
</ul>
<p><br><br><br><br></p>
<p><strong>Punchline:</strong> If treatment <span class="math inline">\(A\)</span> and outcome <span class="math inline">\(Y\)</span> are d-separated given <span class="math inline">\(Z\)</span> under the null, we can estimate desired “do” probabilities with</p>
<p><span class="math display">\[ P(Y = 1 \mid \hbox{do}(A = a)) = \frac{\sum_i w_i y_i}{\sum_i w_i} \]</span></p>
<p>where the weights <span class="math inline">\(w_i\)</span> are the inverse propensity scores:</p>
<ul>
<li><span class="math inline">\(w_i = 1/P(A = 1 \mid Z)\)</span> if <span class="math inline">\(a = 1\)</span></li>
<li><span class="math inline">\(w_i = 1/P(A = 0 \mid Z)\)</span> if <span class="math inline">\(a = 0\)</span></li>
</ul>
<p>When <span class="math inline">\(Z\)</span> contains many variables, we can’t tabulate as we did by hand (too many combinations of predictor levels relative to our sample size). Need to <strong>model</strong> treatment as a function of the variables in <span class="math inline">\(Z\)</span>.</p>
<ul>
<li>Logistic regression</li>
<li>Other techniques from Statistical Machine Learning</li>
</ul>
<p><br><br><br><br></p>
</div>
<div id="exercise-simulation-planning" class="section level3 unnumbered">
<h3>Exercise: Simulation planning</h3>
<p><strong>Goal:</strong> Plan (then implement) a simulation that shows that inverse probability of treatment weighting (IPTW) to estimate average causal effects gives the same results as using the do-operator. This will be done in the context of the DAG below.</p>
<p><img src="causal_manual_files/figure-html/05-fig-sim-plan-1.png" width="576" style="display: block; margin: auto;" /></p>
<p><strong>Plan:</strong> As you go through this planning, think about what code you would have to write (in broad terms) and the order in which you would have to run those commands. For this exercise, don’t look at the code below. We’ll get to it next.</p>
<ul>
<li>Phase 1:
<ul>
<li>How would you simulate the DAG below? (All variables binary.)</li>
<li>How would you simulate new versions of <code>Y</code> under the manipulated graphs resulting from <code>do(A = 1)</code> and <code>do(A = 0)</code>?</li>
<li>How would you compute the average causal effect from <code>do</code>-ing?</li>
</ul></li>
<li>Phase 2:
<ul>
<li>How would you estimate the propensity score for each individual?</li>
<li>How would you estimate <code>P(Y = 1 | do(A = 1))</code> and <code>P(Y = 1 | do(A = 0))</code> using those estimated propensity scores?</li>
</ul></li>
</ul>
<p><br></p>
<p>After your planning phase, step through the code in the section below, and make sure that you understand what each line is doing. Clarify with the instructor as needed.</p>
<p><br><br><br><br></p>
</div>
<div id="simulation-example" class="section level3 unnumbered">
<h3>Simulation example</h3>
<p>A template Rmd is available <a href="template_rmds/05-estimating-causal-effects.Rmd">here</a>.</p>
<p><strong>Task 1:</strong> What is the point of this simulation exercise? What are we trying to show? Clearly explain how we are approaching causal effect estimation from two seemingly different viewpoints.</p>
<p><strong>Task 2:</strong> Explain in detail all steps taken in this code. Do this by breaking the code into smaller code chunks and adding text in between.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)</code></pre></div>
<p><strong>Phase 1:</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">22</span>)
n &lt;-<span class="st"> </span><span class="fl">1e6</span>
Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.5</span>)
p_A &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.8</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.3</span>
)
A &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_A)
p_Y &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.3</span>,
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.6</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.9</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.2</span>
)
Y &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_Y)
A_do_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, n)
A_do_<span class="dv">0</span> &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, n)

p_Y_Ado1 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">1</span><span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.3</span>,
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">1</span><span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.6</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">1</span><span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.9</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">1</span><span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.2</span>
)
Y_Ado1 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_Y_Ado1)

p_Y_Ado0 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">0</span><span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.3</span>,
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">0</span><span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.6</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">0</span><span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.9</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>A_do_<span class="dv">0</span><span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.2</span>
)
Y_Ado0 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> p_Y_Ado0)


sim_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Z, A, Y, Y_Ado1, Y_Ado0)

<span class="kw">sum</span>(sim_data<span class="op">$</span>Y_Ado1<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span>n
<span class="kw">sum</span>(sim_data<span class="op">$</span>Y_Ado0<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span>n

(<span class="kw">sum</span>(sim_data<span class="op">$</span>Y_Ado1<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span>n)<span class="op">-</span>(<span class="kw">sum</span>(sim_data<span class="op">$</span>Y_Ado0<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span>n)</code></pre></div>
<p><strong>Phase 2:</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fit a logistic regression model to estimate propensity scores</span>
ps_mod &lt;-<span class="st"> </span><span class="kw">glm</span>(A <span class="op">~</span><span class="st"> </span>Z, <span class="dt">data =</span> sim_data, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>)

<span class="co"># Get the actual propensity scores</span>
<span class="co"># predict(..., type = &quot;response&quot;) gives the predicted probabilities from logistic regression</span>
<span class="co"># What computations are going on behind the scenes?</span>
sim_data<span class="op">$</span>PS &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    A<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="kw">predict</span>(ps_mod, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>),
    A<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span><span class="op">-</span><span class="kw">predict</span>(ps_mod, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
)

<span class="co"># Form inverse probability weights</span>
sim_data<span class="op">$</span>weight &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>sim_data<span class="op">$</span>PS

<span class="co"># Use the IP weights to estimate:</span>
<span class="co"># (1) the average outcome if all people were treated</span>
<span class="co"># (2) the average outcome if all people were untreated</span>
<span class="co"># group_by() forms groups according to the given variable</span>
<span class="co"># summarize() computes a summary measure for those groups</span>
results &lt;-<span class="st"> </span>sim_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(A) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(<span class="dt">Y_po_estim =</span> <span class="kw">sum</span>(Y<span class="op">*</span>weight)<span class="op">/</span><span class="kw">sum</span>(weight))

<span class="co"># Display estimates (1) and (2)</span>
results

<span class="co"># Compute the estimated average causal effect (ACE)</span>
<span class="co"># How does it compare to the truth from &quot;do&quot;ing?</span>
<span class="kw">diff</span>(results<span class="op">$</span>Y_po_estim)</code></pre></div>
</div>
<div id="on-your-own" class="section level3 unnumbered">
<h3>On your own</h3>
<p>Adapt the simulation to a situation with 2 confounders <code>Z</code> and <code>W</code> as in the DAG below:</p>
<p><img src="causal_manual_files/figure-html/05-fig-sim-exercise-1.png" width="576" style="display: block; margin: auto;" /></p>
<p><strong>Note:</strong> To simulate dependence on 3 or more variables (e.g., A depends on B, C, and D), an easier approach is to do as below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_B &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    B<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.8</span>,
    B<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.4</span>
)
p_C &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    C<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.9</span>,
    C<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.5</span>
)
p_D &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    D<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.7</span>,
    D<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.1</span>
)
p_A &lt;-<span class="st"> </span>p_B<span class="op">*</span>p_C<span class="op">*</span>p_D</code></pre></div>
<p>If ever <code>D</code> is equal to 1 for all cases, <code>p_A</code> can be updated as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_A_D1 &lt;-<span class="st"> </span>p_B<span class="op">*</span>p_C<span class="op">*</span><span class="fl">0.7</span></code></pre></div>
<p>If ever <code>D</code> is equal to 0 for all cases, <code>p_A</code> can be updated as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_A_D1 &lt;-<span class="st"> </span>p_B<span class="op">*</span>p_C<span class="op">*</span><span class="fl">0.1</span></code></pre></div>
<p><br><br></p>
<p><strong>Questions and Tasks:</strong></p>
<p>When you generate <span class="math inline">\(A\)</span>, use the following probabilities:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p_A &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">case_when</span>(
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>W<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.3</span>,
    Z<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>W<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.6</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>W<span class="op">==</span><span class="dv">1</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.9</span>,
    Z<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>W<span class="op">==</span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span><span class="fl">0.2</span>
)</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>How close are your estimates of the ACE from IP weighting and from graph surgery?</p></li>
<li><p>Take a careful look at the probabilities used to generate the treatment <span class="math inline">\(A\)</span>, and re-examine the form of your propensity score model. Thinking about what the coefficients mean in your propensity score (PS) model, what would you need to do to improve your propensity score model?</p></li>
<li><p>Fit this new PS model as <code>ps_mod2</code>. Add a second PS variable <code>PS2</code>, and create a corresponding <code>weight2</code> variable.</p></li>
<li><p>Store the results from both PS models with something similar to below, Display the estimated ACE resulting from both models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results &lt;-<span class="st"> </span>sim_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(A) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(
        <span class="dt">Y_po_estim1 =</span> <span class="kw">sum</span>(Y<span class="op">*</span>weight1)<span class="op">/</span><span class="kw">sum</span>(weight1),
        <span class="dt">Y_po_estim2 =</span> <span class="kw">sum</span>(Y<span class="op">*</span>weight2)<span class="op">/</span><span class="kw">sum</span>(weight2)
    )</code></pre></div></li>
<li><p>Repeat this simulation using numbers for <code>p_A</code> that make the simpler PS model valid. As before, show the results of both the simpler and more complex PS model.</p></li>
</ol>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="d-separation-part-2.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ip-weighting-in-practice.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
